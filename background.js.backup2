// Background Service Worker - PDFä¸Šä¼ ç‰ˆæœ¬

// ç›‘å¬æ¥è‡ªpopupçš„æ¶ˆæ¯
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'openGemini') {
    handleOpenGeminiWithPDF(request.data)
      .then(result => sendResponse(result))
      .catch(error => sendResponse({ success: false, error: error.message }));
    return true;
  }
});

// å¤„ç†æ‰“å¼€Geminiå¹¶æäº¤å†…å®¹
async function handleOpenGeminiWithPDF(pageContent) {
  try {
    console.log('ğŸš€ å¼€å§‹å†…å®¹æäº¤æµç¨‹...');

    const settings = await chrome.storage.sync.get({
      openInBackground: true
    });

    // ç¬¬1æ­¥ï¼šè·å–å½“å‰æ ‡ç­¾é¡µ
    const [currentTab] = await chrome.tabs.query({ active: true, currentWindow: true });
    console.log('âœ… æ­¥éª¤1/4: è·å–å½“å‰æ ‡ç­¾é¡µæˆåŠŸ, TabID:', currentTab.id);
    console.log('   å½“å‰URL:', currentTab.url);

    // æ£€æŸ¥æ˜¯å¦ä¸ºå—é™é¡µé¢
    const url = currentTab.url || '';
    const restrictedPatterns = [
      'chrome://',
      'chrome-extension://',
      'edge://',
      'about:',
      'view-source:',
      'chrome.google.com/webstore',
      'microsoftedge.microsoft.com/addons',
      'data:',
      'devtools://'
    ];

    const isRestricted = restrictedPatterns.some(pattern => url.startsWith(pattern) || url.includes(pattern));

    if (isRestricted) {
      throw new Error('âŒ æ— æ³•åœ¨å—ä¿æŠ¤çš„é¡µé¢ä½¿ç”¨æ­¤åŠŸèƒ½\n\næ­¤é¡µé¢ç±»å‹ä¸æ”¯æŒï¼š\nâ€¢ Chromeå†…éƒ¨é¡µé¢ï¼ˆchrome://ï¼‰\nâ€¢ æµè§ˆå™¨æ‰©å±•å•†åº—\nâ€¢ æ‰©å±•ç¨‹åºé¡µé¢\nâ€¢ æ•°æ®URLï¼ˆdata:ï¼‰\n\nğŸ’¡ è¯·åœ¨æ™®é€šç½‘é¡µä¸Šä½¿ç”¨æ­¤æ‰©å±•');
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºç™½é¡µæˆ–æ–°æ ‡ç­¾é¡µ
    if (!url || url === 'about:blank' || url === 'chrome://newtab/' || url === 'edge://newtab/') {
      throw new Error('âŒ æ— æ³•åœ¨ç©ºç™½é¡µé¢ä½¿ç”¨æ­¤åŠŸèƒ½\n\nğŸ’¡ è¯·æ‰“å¼€ä¸€ä¸ªç½‘é¡µåå†ä½¿ç”¨');
    }

    // ç¬¬2æ­¥ï¼šæ‰“å¼€Gemini
    console.log('ğŸŒ æ­¥éª¤2/4: æ‰“å¼€Geminiçª—å£...');
    const { geminiTab, currentWindow } = await openGeminiWindow(currentTab, settings);
    console.log('âœ… æ­¥éª¤2/4: Geminiçª—å£æ‰“å¼€æˆåŠŸ');

    // ç¬¬3æ­¥ï¼šç­‰å¾…GeminiåŠ è½½
    console.log('â³ æ­¥éª¤3/4: ç­‰å¾…Geminié¡µé¢åŠ è½½...');
    await waitForTabLoad(geminiTab.id);
    console.log('âœ… æ­¥éª¤3/4: Geminié¡µé¢åŠ è½½å®Œæˆ');

    // ç¬¬4æ­¥ï¼šæäº¤å†…å®¹åˆ°Gemini
    console.log('ğŸ“¤ æ­¥éª¤4/4: æäº¤å†…å®¹åˆ°Gemini...');
    await submitContentToGemini(geminiTab.id, pageContent);
    console.log('âœ… æ­¥éª¤4/4: å†…å®¹å·²æˆåŠŸæäº¤åˆ°Gemini!');

    // å¦‚æœå‹¾é€‰äº†åå°æ‰“å¼€ï¼Œå›åˆ°åŸçª—å£
    if (settings.openInBackground) {
      await chrome.windows.update(currentWindow.id, {
        focused: true
      });
    }

    return {
      success: true,
      message: 'âœ… å†…å®¹å·²æˆåŠŸæäº¤åˆ°Geminiï¼'
    };
  } catch (error) {
    console.error('âŒ æµç¨‹å¤±è´¥:', error);
    throw error;
  }
}

// ç”ŸæˆPDFï¼ˆä½¿ç”¨ Chrome DevTools Protocolï¼‰
async function generatePDF(tabId, pageContent) {
  try {
    console.log('  ğŸ“„ ä½¿ç”¨ Chrome DevTools Protocol ç”Ÿæˆ PDF...');

    // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è°ƒè¯•å™¨åœ¨ä½¿ç”¨
    try {
      const targets = await chrome.debugger.getTargets();
      const currentTarget = targets.find(t => t.tabId === tabId);
      if (currentTarget && currentTarget.attached) {
        throw new Error('æ­¤æ ‡ç­¾é¡µå·²è¢«è°ƒè¯•å™¨å ç”¨ï¼Œè¯·å…³é—­ DevTools åé‡è¯•');
      }
    } catch (e) {
      console.warn('  âš ï¸ æ— æ³•æ£€æŸ¥è°ƒè¯•å™¨çŠ¶æ€:', e.message);
    }

    // é™„åŠ è°ƒè¯•å™¨
    try {
      await chrome.debugger.attach({ tabId }, '1.3');
      console.log('  âœ… è°ƒè¯•å™¨å·²é™„åŠ ');
    } catch (attachError) {
      console.error('  âŒ é™„åŠ è°ƒè¯•å™¨å¤±è´¥:', attachError);
      console.error('  é”™è¯¯è¯¦æƒ…:', {
        message: attachError.message,
        stack: attachError.stack
      });
      throw attachError;
    }

    try {
      // ä½¿ç”¨ Page.printToPDF å‘½ä»¤
      const result = await chrome.debugger.sendCommand(
        { tabId },
        'Page.printToPDF',
        {
          printBackground: true,
          landscape: false,
          displayHeaderFooter: false,
          preferCSSPageSize: false,
          marginTop: 0.4,
          marginBottom: 0.4,
          marginLeft: 0.4,
          marginRight: 0.4
        }
      );

      // åˆ†ç¦»è°ƒè¯•å™¨
      await chrome.debugger.detach({ tabId });
      console.log('  âœ… è°ƒè¯•å™¨å·²åˆ†ç¦»');

      // è½¬æ¢ä¸º DataURL
      const dataUrl = `data:application/pdf;base64,${result.data}`;
      console.log('  âœ… PDF ç”ŸæˆæˆåŠŸ');

      return dataUrl;
    } catch (error) {
      // ç¡®ä¿åˆ†ç¦»è°ƒè¯•å™¨
      try {
        await chrome.debugger.detach({ tabId });
      } catch (e) {
        // å¿½ç•¥
      }
      throw error;
    }
  } catch (error) {
    console.error('  âŒ PDF ç”Ÿæˆå¤±è´¥:', error);

    // æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    let errorMessage = error.message;

    // æ›´è¯¦ç»†çš„é”™è¯¯åŒ¹é…
    if (errorMessage.includes('Cannot access') ||
        errorMessage.includes('Cannot attach') ||
        errorMessage.includes('No target')) {
      errorMessage = 'âŒ è°ƒè¯•å™¨æ— æ³•é™„åŠ åˆ°æ­¤é¡µé¢\n\nå¯èƒ½çš„åŸå› ï¼š\n1. è¿™æ˜¯å—ä¿æŠ¤çš„é¡µé¢ï¼ˆChromeå•†åº—ã€å†…éƒ¨é¡µé¢ç­‰ï¼‰\n2. é¡µé¢æ­£åœ¨è¢«å…¶ä»–å·¥å…·è°ƒè¯•ï¼ˆè¯·å…³é—­ DevToolsï¼‰\n3. è¿™æ˜¯æ‰©å±•ç¨‹åºé¡µé¢æˆ–PDFé¢„è§ˆé¡µé¢\n\nğŸ’¡ è§£å†³æ–¹æ³•ï¼šè¯·åœ¨æ™®é€šç½‘é¡µä¸Šä½¿ç”¨æ­¤åŠŸèƒ½';
    } else if (errorMessage.includes('debugger')) {
      errorMessage = 'âŒ è°ƒè¯•å™¨è¿æ¥å¤±è´¥\n\nè¯·å°è¯•ï¼š\n1. åˆ·æ–°é¡µé¢åé‡è¯•\n2. å…³é—­æµè§ˆå™¨çš„ DevTools å¼€å‘è€…å·¥å…·\n3. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ‰©å±•å ç”¨äº†è°ƒè¯•å™¨';
    } else if (errorMessage.includes('å·²è¢«è°ƒè¯•å™¨å ç”¨')) {
      // ä¿æŒåŸæ ·
    }

    throw new Error(errorMessage);
  }
}

// æ‰“å¼€Geminiçª—å£
async function openGeminiWindow(currentTab, settings) {
  // è·å–å½“å‰çª—å£ä¿¡æ¯
  const currentWindow = await chrome.windows.get(currentTab.windowId);

  // è®¡ç®—å³ä¾§ä½ç½®
  const newWidth = Math.floor(currentWindow.width / 2);
  const newLeft = currentWindow.left + newWidth;

  // Gemini URL
  const geminiUrl = `https://gemini.google.com/app`;

  // åœ¨å³ä¾§åˆ›å»ºæ–°çª—å£
  const newWindow = await chrome.windows.create({
    url: geminiUrl,
    type: 'normal',
    width: newWidth,
    height: currentWindow.height,
    left: newLeft,
    top: currentWindow.top,
    focused: !settings.openInBackground
  });

  // è°ƒæ•´åŸçª—å£å¤§å°
  await chrome.windows.update(currentWindow.id, {
    width: newWidth,
    left: currentWindow.left
  });

  return {
    geminiTab: newWindow.tabs[0],
    currentWindow: currentWindow
  };
}

// ç­‰å¾…æ ‡ç­¾é¡µåŠ è½½å®Œæˆ
function waitForTabLoad(tabId) {
  return new Promise((resolve) => {
    const checkTab = async () => {
      const tab = await chrome.tabs.get(tabId);
      if (tab.status === 'complete') {
        // é¢å¤–ç­‰å¾…3ç§’ç¡®ä¿Geminiå®Œå…¨åˆå§‹åŒ–
        setTimeout(resolve, 3000);
      } else {
        setTimeout(checkTab, 100);
      }
    };
    checkTab();
  });
}

// ä¸Šä¼ PDFåˆ°Gemini
async function uploadPDFToGemini(tabId, pdfDataUrl, pageContent) {
  try {
    console.log('  ğŸ“¤ å‡†å¤‡ä¸Šä¼ PDF...');

    // æ„å»ºæç¤ºè¯
    const prompt = await buildPromptForPDF(pageContent);

    // æ³¨å…¥ä¸Šä¼ è„šæœ¬
    await chrome.scripting.executeScript({
      target: { tabId: tabId },
      func: uploadPDFAndSubmit,
      args: [pdfDataUrl, prompt, pageContent.title]
    });

    console.log('  âœ… ä¸Šä¼ è„šæœ¬å·²æ³¨å…¥');
  } catch (error) {
    console.error('  âŒ ä¸Šä¼ PDFå¤±è´¥:', error);
    throw new Error('ä¸Šä¼ å¤±è´¥: ' + error.message);
  }
}

// æ„å»ºPDFçš„æç¤ºè¯
async function buildPromptForPDF(pageContent) {
  const { title, url } = pageContent;

  let prompt = `ğŸ“„ å®Œæ•´ç½‘é¡µPDFåˆ†æè¯·æ±‚\n\n`;
  prompt += `**æ ‡é¢˜**: ${title}\n`;
  prompt += `**ç½‘å€**: ${url}\n`;
  prompt += `**æå–æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}\n\n`;
  prompt += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
  prompt += `ğŸ“ **è¯´æ˜**: å·²å°†å®Œæ•´ç½‘é¡µè½¬æ¢ä¸ºPDFæ–‡æ¡£ä¸Šä¼ ï¼Œè¯·ç›´æ¥é˜…è¯»PDFæ–‡ä»¶ä¸­çš„å®Œæ•´å†…å®¹è¿›è¡Œåˆ†æã€‚\n\n`;

  // è·å–å½“å‰æ´»åŠ¨çš„é…ç½®
  try {
    const result = await chrome.storage.sync.get({
      promptConfigs: [
        {
          id: 'config-1',
          name: 'æ·±åº¦é˜…è¯»åˆ†æ',
          prompt: getDefaultPrompt(),
          active: true
        }
      ],
      activeConfigId: 'config-1'
    });

    const activeConfig = result.promptConfigs.find(c => c.id === result.activeConfigId);
    if (activeConfig && activeConfig.prompt) {
      prompt += activeConfig.prompt;
    } else {
      prompt += getDefaultPrompt();
    }
  } catch (error) {
    console.error('âŒ è·å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æç¤ºè¯:', error);
    prompt += getDefaultPrompt();
  }

  return prompt;
}

// è·å–é»˜è®¤æç¤ºè¯
function getDefaultPrompt() {
  return `## ğŸ“Š æ·±åº¦åˆ†æè¦æ±‚\n\nè¯·ä½¿ç”¨ **Gemini 2.5 Pro** æ¨¡å‹ï¼ŒåŸºäºã€Šå¦‚ä½•é˜…è¯»ä¸€æœ¬ä¹¦ã€‹çš„é˜…è¯»æŠ€å·§ï¼Œå¯¹ä¸Šè¿°å®Œæ•´ç½‘é¡µå†…å®¹è¿›è¡Œå¤šç»´åº¦æ·±åº¦åˆ†æï¼š\n\n### 1ï¸âƒ£ æ•´ä½“ç†è§£\n(1) æ•´ä½“æ¥è¯´ï¼Œè¿™ä¸ªç½‘é¡µåˆ°åº•åœ¨è°ˆäº›ä»€ä¹ˆï¼Ÿ\n- ä½ ä¸€å®šè¦æƒ³åŠæ³•æ‰¾å‡ºè¿™ä¸ªç½‘é¡µçš„ä¸»é¢˜ï¼Œä½œè€…å¦‚ä½•ä¾æ¬¡å‘å±•è¿™ä¸ªä¸»é¢˜ã€‚\n\n### 2ï¸âƒ£ ç»†èŠ‚åˆ†æ\n(2) ä½œè€…ç»†éƒ¨è¯´äº†ä»€ä¹ˆï¼Œæ€ä¹ˆè¯´çš„ï¼Ÿ\n- æ‰¾å‡ºä¸»è¦çš„æƒ³æ³•ã€å£°æ˜ä¸è®ºç‚¹ã€‚\n\n### 3ï¸âƒ£ åˆç†æ€§è¯„ä¼°\n(3) è¿™ä¸ªç½‘é¡µè¯´å¾—æœ‰é“ç†å—ï¼Ÿ\n- è¯„ä¼°å†…å®¹çš„å‡†ç¡®æ€§å’Œé€»è¾‘æ€§ã€‚\n\n### 4ï¸âƒ£ å®ç”¨ä»·å€¼\n(4) è¿™ä¸ªç½‘é¡µè·Ÿä½ æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ\n- åˆ†æå…¶å®ç”¨ä»·å€¼å’Œå¯¹è¯»è€…çš„å¯ç¤ºã€‚\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ“ **è¯·ç”¨ä¸­æ–‡è¿›è¡Œå…¨é¢ã€æ·±å…¥ã€ç»“æ„åŒ–çš„åˆ†æã€‚**`;
}

// ä¸Šä¼ PDFå¹¶æäº¤ï¼ˆæ³¨å…¥åˆ°Geminié¡µé¢æ‰§è¡Œï¼‰
function uploadPDFAndSubmit(pdfDataUrl, promptText, pageTitle) {
  console.log('ğŸš€ å¼€å§‹ä¸Šä¼ PDFå¹¶è‡ªåŠ¨æäº¤...');
  console.log('ğŸ“ æç¤ºè¯é•¿åº¦:', promptText ? promptText.length : 0);
  console.log('ğŸ“„ é¡µé¢æ ‡é¢˜:', pageTitle);
  console.log('ğŸ“„ PDF DataURLå¤§å°:', (pdfDataUrl.length / 1024 / 1024).toFixed(2), 'MB');

  try {
    // æ­¥éª¤1: åˆ‡æ¢åˆ°2.5Proæ¨¡å‹
    console.log('ğŸ”„ æ­¥éª¤1: æ£€æŸ¥å¹¶åˆ‡æ¢åˆ°2.5Proæ¨¡å‹...');
    switchTo25Pro();

    // æ­¥éª¤2: å¡«å……æç¤ºè¯å¹¶ä¸Šä¼ PDF
    setTimeout(() => {
      console.log('ğŸ“ æ­¥éª¤2: å¡«å……æç¤ºè¯åˆ°è¾“å…¥æ¡†...');
      const inputBox = findInputBox();
      if (!inputBox) {
        console.error('âŒ æœªæ‰¾åˆ°è¾“å…¥æ¡†');
        return;
      }

      inputBox.textContent = promptText;
      inputBox.dispatchEvent(new Event('input', { bubbles: true }));
      inputBox.focus();
      console.log('âœ… æç¤ºè¯å·²å¡«å……');

      // æ­¥éª¤3: æ‹–æ‹½ä¸Šä¼ PDF
      setTimeout(() => {
        console.log('ğŸ“¤ æ­¥éª¤3: æ‹–æ‹½ä¸Šä¼ PDF...');
        uploadPDFByDrop(pdfDataUrl, pageTitle, inputBox);
      }, 1000);
    }, 2000); // ç­‰å¾…æ¨¡å‹åˆ‡æ¢å®Œæˆ

  } catch (error) {
    console.error('âŒ æ•´ä½“æµç¨‹å¤±è´¥:', error);
  }

  // è¾…åŠ©å‡½æ•°ï¼šåˆ‡æ¢åˆ°2.5Pro
  function switchTo25Pro() {
    try {
      // æŸ¥æ‰¾æ‰€æœ‰æŒ‰é’®ï¼Œå¯»æ‰¾æ¨¡å‹é€‰æ‹©å™¨
      const allButtons = Array.from(document.querySelectorAll('button'));

      console.log(`ğŸ” æŸ¥æ‰¾æ¨¡å‹é€‰æ‹©å™¨ï¼Œå…± ${allButtons.length} ä¸ªæŒ‰é’®`);

      for (const btn of allButtons) {
        const text = btn.textContent || '';

        // å¦‚æœå½“å‰æ˜¯Flashï¼Œéœ€è¦åˆ‡æ¢
        if (text.includes('Flash') || text.includes('flash')) {
          console.log('ğŸ” å‘ç°Flashæ¨¡å‹æŒ‰é’®ï¼Œç‚¹å‡»æ‰“å¼€èœå•...');
          console.log('   æŒ‰é’®æ–‡æœ¬:', text);
          btn.click();

          // ç­‰å¾…èœå•å‡ºç°ï¼Œç„¶åé€‰æ‹©Pro
          setTimeout(() => {
            // æŸ¥æ‰¾Proé€‰é¡¹ï¼ˆå¢åŠ æ›´å¤šé€‰æ‹©å™¨ï¼‰
            const menuItems = document.querySelectorAll(
              'button, [role="menuitem"], [role="option"], div[role="button"], [role="listitem"], li'
            );
            console.log(`ğŸ” æŸ¥æ‰¾Proé€‰é¡¹ï¼Œå…± ${menuItems.length} ä¸ªå€™é€‰é¡¹`);

            for (const option of menuItems) {
              const optionText = option.textContent || '';

              // æ£€æŸ¥æ˜¯å¦åŒ…å« "Pro" å’Œç‰ˆæœ¬å·
              if ((optionText.includes('Pro') || optionText.includes('pro')) &&
                  (optionText.includes('2.5') || optionText.includes('2.0') || optionText.includes('Gemini'))) {
                console.log('âœ… æ‰¾åˆ°Proé€‰é¡¹ï¼Œç‚¹å‡»é€‰æ‹©');
                console.log('   é€‰é¡¹æ–‡æœ¬:', optionText);
                console.log('   å…ƒç´ ç±»å‹:', option.tagName);

                // ç‚¹å‡»å…ƒç´ 
                option.click();

                // å¦‚æœç‚¹å‡»æ²¡ååº”ï¼Œå°è¯•è§¦å‘é¼ æ ‡äº‹ä»¶
                setTimeout(() => {
                  const clickEvent = new MouseEvent('click', {
                    view: window,
                    bubbles: true,
                    cancelable: true
                  });
                  option.dispatchEvent(clickEvent);
                  console.log('âœ… å·²è§¦å‘ç‚¹å‡»äº‹ä»¶');
                }, 100);

                return;
              }
            }
            console.warn('âš ï¸ æœªæ‰¾åˆ°Proé€‰é¡¹ï¼Œæ‰“å°æ‰€æœ‰å€™é€‰é¡¹:');
            menuItems.forEach((item, index) => {
              if (index < 10) { // åªæ‰“å°å‰10ä¸ª
                console.log(`   [${index}] ${item.textContent?.substring(0, 50)}`);
              }
            });
          }, 1000); // å¢åŠ åˆ°1ç§’ç­‰å¾…æ—¶é—´

          return;
        }

        // å¦‚æœå·²ç»æ˜¯Proï¼Œä¸éœ€è¦åˆ‡æ¢
        if ((text.includes('Pro') || text.includes('pro')) &&
            (text.includes('2.5') || text.includes('2.0'))) {
          console.log('âœ… å½“å‰å·²ç»æ˜¯Proæ¨¡å‹ï¼Œæ— éœ€åˆ‡æ¢');
          console.log('   æŒ‰é’®æ–‡æœ¬:', text);
          return;
        }
      }

      console.log('âš ï¸ æœªæ‰¾åˆ°æ¨¡å‹é€‰æ‹©å™¨ï¼Œå‡è®¾å·²ç»æ˜¯Proæ¨¡å‹');
    } catch (error) {
      console.error('âŒ åˆ‡æ¢æ¨¡å‹å¤±è´¥:', error);
    }
  }

  // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾è¾“å…¥æ¡†
  function findInputBox() {
    const selectors = [
      '[contenteditable="true"]',
      'rich-textarea [contenteditable="true"]',
      'div[contenteditable="true"][role="textbox"]'
    ];

    for (const selector of selectors) {
      const inputBox = document.querySelector(selector);
      if (inputBox) {
        console.log('âœ… æ‰¾åˆ°è¾“å…¥æ¡†:', selector);
        return inputBox;
      }
    }

    console.error('âŒ æœªæ‰¾åˆ°è¾“å…¥æ¡†');
    return null;
  }

  // è¾…åŠ©å‡½æ•°ï¼šé€šè¿‡æ‹–æ‹½ä¸Šä¼ PDF
  function uploadPDFByDrop(dataUrl, fileName, inputBox) {
    try {
      console.log('ğŸ¯ å¼€å§‹æ‹–æ‹½ä¸Šä¼ PDF...');

      // å°†DataURLè½¬æ¢ä¸ºBlob
      const arr = dataUrl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      const blob = new Blob([u8arr], { type: mime });

      console.log('âœ… PDFè½¬æ¢ä¸ºBlobå®Œæˆ, å¤§å°:', (blob.size / 1024 / 1024).toFixed(2), 'MB');

      // åˆ›å»ºFileå¯¹è±¡
      const file = new File([blob], (fileName || 'webpage') + '.pdf', { type: 'application/pdf' });

      // åˆ›å»ºDataTransferå¹¶æ·»åŠ æ–‡ä»¶
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);

      // è§¦å‘æ‹–æ‹½äº‹ä»¶
      const dragenterEvent = new DragEvent('dragenter', {
        bubbles: true,
        cancelable: true,
        dataTransfer: dataTransfer
      });

      const dragoverEvent = new DragEvent('dragover', {
        bubbles: true,
        cancelable: true,
        dataTransfer: dataTransfer
      });

      const dropEvent = new DragEvent('drop', {
        bubbles: true,
        cancelable: true,
        dataTransfer: dataTransfer
      });

      inputBox.dispatchEvent(dragenterEvent);
      inputBox.dispatchEvent(dragoverEvent);
      inputBox.dispatchEvent(dropEvent);

      console.log('âœ… æ‹–æ‹½äº‹ä»¶å·²è§¦å‘');

      // æ­¥éª¤4: ç­‰å¾…æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼ˆè§‚å¯ŸDOMå˜åŒ–ï¼‰
      console.log('â³ æ­¥éª¤4: ç­‰å¾…æ–‡ä»¶ä¸Šä¼ å®Œæˆ...');
      waitForFileUpload(inputBox);

    } catch (error) {
      console.error('âŒ æ‹–æ‹½ä¸Šä¼ å¤±è´¥:', error);
    }
  }

  // è¾…åŠ©å‡½æ•°ï¼šç­‰å¾…æ–‡ä»¶ä¸Šä¼ å®Œæˆ
  function waitForFileUpload(inputBox) {
    let checkCount = 0;
    const maxChecks = 30; // æœ€å¤šç­‰å¾…15ç§’

    const checkUpload = () => {
      checkCount++;

      // æŸ¥æ‰¾ä¸Šä¼ å®Œæˆçš„æ ‡å¿—
      // Geminiä¼šåœ¨ä¸Šä¼ åæ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
      const filePreview = document.querySelector('[data-test-id*="attachment"]') ||
                         document.querySelector('.upload-preview') ||
                         document.querySelector('[class*="attachment"]') ||
                         document.querySelector('[aria-label*="é™„ä»¶"]') ||
                         document.querySelector('[aria-label*="attachment"]');

      if (filePreview) {
        console.log(`âœ… æ£€æµ‹åˆ°æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼ˆæ£€æŸ¥${checkCount}æ¬¡ï¼‰`);

        // æ­¥éª¤5: æŸ¥æ‰¾å¹¶ç‚¹å‡»æäº¤æŒ‰é’®
        setTimeout(() => {
          console.log('ğŸš€ æ­¥éª¤5: æŸ¥æ‰¾å¹¶ç‚¹å‡»æäº¤æŒ‰é’®...');
          findAndClickSubmitButton(inputBox);
        }, 1000);

        return;
      }

      if (checkCount >= maxChecks) {
        console.warn(`âš ï¸ ç­‰å¾…ä¸Šä¼ è¶…æ—¶ï¼ˆ${checkCount}æ¬¡æ£€æŸ¥ï¼‰ï¼Œå°è¯•ç‚¹å‡»æäº¤`);
        findAndClickSubmitButton(inputBox);
        return;
      }

      // ç»§ç»­æ£€æŸ¥
      setTimeout(checkUpload, 500);
    };

    // å¼€å§‹æ£€æŸ¥
    setTimeout(checkUpload, 2000); // å…ˆç­‰2ç§’å†å¼€å§‹æ£€æŸ¥
  }

  // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾å¹¶ç‚¹å‡»æäº¤æŒ‰é’®
  function findAndClickSubmitButton(inputBox) {
    console.log('ğŸ” æŸ¥æ‰¾æäº¤æŒ‰é’®ï¼ˆè¾“å…¥æ¡†å³ä¸‹è§’ï¼‰...');

    const inputRect = inputBox.getBoundingClientRect();
    const buttons = document.querySelectorAll('button');

    let submitButton = null;
    let bestScore = 0;

    for (const btn of buttons) {
      if (btn.disabled) continue;

      const rect = btn.getBoundingClientRect();
      const ariaLabel = btn.getAttribute('aria-label') || '';
      const title = btn.getAttribute('title') || '';
      const hasSvg = btn.querySelector('svg') !== null;

      // ä½ç½®æ£€æŸ¥ï¼šåœ¨è¾“å…¥æ¡†å³ä¾§ä¸”é è¿‘åº•éƒ¨
      const isRightOfInput = rect.left > inputRect.right - 200;
      const isNearBottomOfInput =
        rect.top >= inputRect.bottom - 100 &&
        rect.top <= inputRect.bottom + 100;

      // å±æ€§æ£€æŸ¥
      const isSubmitButton =
        ariaLabel.includes('å‘é€') ||
        ariaLabel.includes('send') ||
        ariaLabel.includes('Send') ||
        title.includes('å‘é€');

      // è®¡ç®—å¾—åˆ†
      let score = 0;
      if (isRightOfInput && isNearBottomOfInput) score += 10;
      if (hasSvg) score += 5;
      if (isSubmitButton) score += 8;
      if (rect.width < 60 && rect.height < 60) score += 3;

      if (score > bestScore) {
        bestScore = score;
        submitButton = btn;
      }
    }

    if (submitButton && bestScore > 10) {
      console.log(`âœ… æ‰¾åˆ°æœ€ä½³æäº¤æŒ‰é’®! å¾—åˆ†: ${bestScore}`);
      submitButton.click();
      console.log('âœ… å·²ç‚¹å‡»æäº¤æŒ‰é’®ï¼');
      return true;
    } else {
      console.error('âŒ æœªæ‰¾åˆ°åˆé€‚çš„æäº¤æŒ‰é’® (æœ€é«˜å¾—åˆ†:', bestScore, ')');
      console.log('ğŸ“ è¯·æ‰‹åŠ¨ç‚¹å‡»æäº¤æŒ‰é’®');
      return false;
    }
  }
}

// ç›‘å¬å¿«æ·é”®
chrome.commands.onCommand.addListener(async (command) => {
  if (command === '_execute_action') {
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

    if (tab) {
      try {
        await chrome.scripting.executeScript({
          target: { tabId: tab.id },
          files: ['content-extractor.js']
        });

        const results = await chrome.scripting.executeScript({
          target: { tabId: tab.id },
          func: () => {
            if (typeof extractPageContent === 'function') {
              return extractPageContent();
            }
          }
        });

        if (results && results[0] && results[0].result) {
          await handleOpenGeminiWithPDF(results[0].result);
        }
      } catch (error) {
        console.error('å¿«æ·é”®æ‰§è¡Œå¤±è´¥:', error);
      }
    }
  }
});
